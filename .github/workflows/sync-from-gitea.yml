name: Sync from Gitea

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸Ð»Ð¸ Ð¿Ð¾ webhook Ð¾Ñ‚ Gitea
on:
  workflow_dispatch:
  repository_dispatch:
    types: [gitea-push]
  schedule:
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ
    - cron: '0 * * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout GitHub repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config --global user.name "Sync Bot"
          git config --global user.email "bot@example.com"
      
      - name: Add Gitea remote
        env:
          GITEA_URL: ${{ secrets.GITEA_URL }}
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
        run: |
          if [ -z "$GITEA_URL" ]; then
            echo "âš ï¸ GITEA_URL Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸ÑŽ"
            exit 0
          fi
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Gitea remote Ñ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼
          git remote add gitea "https://oauth2:${GITEA_TOKEN}@${GITEA_URL#https://}"
          git remote -v
      
      - name: Fetch from Gitea
        run: |
          if git remote | grep -q gitea; then
            echo "ðŸ”„ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð¸Ð· Gitea..."
            git fetch gitea --tags
          else
            echo "âš ï¸ Gitea remote Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
            exit 0
          fi
      
      - name: Check for new commits
        id: check
        run: |
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð½Ð¾Ð²Ñ‹Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹ Ð² Gitea
          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse gitea/main 2>/dev/null || git rev-parse gitea/master 2>/dev/null || echo $LOCAL)
          
          if [ "$LOCAL" != "$REMOTE" ]; then
            echo "new_commits=true" >> $GITHUB_OUTPUT
            echo "âœ… ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð½Ð¾Ð²Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Gitea"
          else
            echo "new_commits=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ÐÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹"
          fi
      
      - name: Merge changes from Gitea
        if: steps.check.outputs.new_commits == 'true'
        run: |
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð³Ð»Ð°Ð²Ð½ÑƒÑŽ Ð²ÐµÑ‚ÐºÑƒ
          if git show-ref --verify --quiet refs/remotes/gitea/main; then
            BRANCH="main"
          else
            BRANCH="master"
          fi
          
          echo "ðŸ”€ Ð¡Ð»Ð¸ÑÐ½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð¸Ð· gitea/${BRANCH}..."
          git merge "gitea/${BRANCH}" --allow-unrelated-histories -m "Sync from Gitea: $(date)"
      
      - name: Push to GitHub
        if: steps.check.outputs.new_commits == 'true'
        run: |
          echo "â¬†ï¸ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð² GitHub..."
          git push origin HEAD:main --force-with-lease
          git push origin --tags
          echo "âœ… Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ”„ ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.new_commits }}" == "true" ]; then
            echo "âœ… **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ**: Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ **ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹**: ÐÐ¾Ð²Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ Ð¸ Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ñ‹" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ**: ÐÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ• **Ð’Ñ€ÐµÐ¼Ñ**: $(date)" >> $GITHUB_STEP_SUMMARY
